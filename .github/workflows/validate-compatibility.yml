name: Validate Mod Compatibility

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to validate'
        required: true
        type: number

jobs:
  validate:
    name: Validate compatibility
    runs-on: ubuntu-latest
    # Only run on PRs with automated-update label or manual trigger
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'automated-update'))

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Setup Packwiz
        run: |
          go install github.com/packwiz/packwiz@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Run validation
        id: validate
        continue-on-error: true
        run: |
          bun run scripts/automation/validate-compatibility.js
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: validation-results.json
          retention-days: 30

      - name: Comment validation results on PR
        if: always() && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Read validation results
          if [ -f validation-results.json ]; then
            RESULTS=$(cat validation-results.json)
            OVERALL_PASS=$(echo "$RESULTS" | jq -r '.overall.passed')

            # Build comment
            {
              echo "## üîç Validation Results"
              echo ""
              echo "| Check | Status |"
              echo "|-------|--------|"

              API_PASS=$(echo "$RESULTS" | jq -r '.apiValidation.passed')
              if [ "$API_PASS" = "true" ]; then
                echo "| API Validation | ‚úÖ PASS |"
              else
                echo "| API Validation | ‚ùå FAIL |"
              fi

              DEP_PASS=$(echo "$RESULTS" | jq -r '.dependencyValidation.passed')
              if [ "$DEP_PASS" = "true" ]; then
                echo "| Dependency Validation | ‚úÖ PASS |"
              else
                echo "| Dependency Validation | ‚ùå FAIL |"
              fi

              BUILD_PASS=$(echo "$RESULTS" | jq -r '.buildValidation.passed')
              if [ "$BUILD_PASS" = "true" ]; then
                echo "| Build Validation | ‚úÖ PASS |"
              else
                echo "| Build Validation | ‚ùå FAIL |"
              fi

              echo ""

              # Show issues if any
              API_ISSUES=$(echo "$RESULTS" | jq -r '.apiValidation.issues | length')
              if [ "$API_ISSUES" -gt 0 ]; then
                echo "<details>"
                echo "<summary>‚ö†Ô∏è API Validation Issues ($API_ISSUES)</summary>"
                echo ""
                echo "$RESULTS" | jq -r '.apiValidation.issues[] | "- " + .'
                echo ""
                echo "</details>"
                echo ""
              fi

              DEP_ISSUES=$(echo "$RESULTS" | jq -r '.dependencyValidation.issues | length')
              if [ "$DEP_ISSUES" -gt 0 ]; then
                echo "<details>"
                echo "<summary>‚ö†Ô∏è Dependency Validation Issues ($DEP_ISSUES)</summary>"
                echo ""
                echo "$RESULTS" | jq -r '.dependencyValidation.issues[] | "- " + .'
                echo ""
                echo "</details>"
                echo ""
              fi

              BUILD_ISSUES=$(echo "$RESULTS" | jq -r '.buildValidation.issues | length')
              if [ "$BUILD_ISSUES" -gt 0 ]; then
                echo "<details>"
                echo "<summary>‚ö†Ô∏è Build Validation Issues ($BUILD_ISSUES)</summary>"
                echo ""
                echo "$RESULTS" | jq -r '.buildValidation.issues[] | "- " + .'
                echo ""
                echo "</details>"
                echo ""
              fi

              if [ "$OVERALL_PASS" = "true" ]; then
                echo "### ‚úÖ Overall: PASS"
                echo ""
                echo "All validation checks passed. This PR is ready for manual testing."
              else
                echo "### ‚ùå Overall: FAIL"
                echo ""
                echo "Some validation checks failed. Please review the issues above before proceeding."
              fi

              echo ""
              echo "---"
              echo "*Validation completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*"
            } > comment.md

            gh pr comment "$PR_NUMBER" --body-file comment.md
          else
            gh pr comment "$PR_NUMBER" --body "‚ùå Validation failed to complete. Check the workflow logs for details."
          fi

      - name: Mark PR as ready for review
        if: steps.validate.outputs.exit_code == '0' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Remove draft status
          gh pr ready "$PR_NUMBER"

          # Remove needs-validation label
          gh pr edit "$PR_NUMBER" --remove-label "needs-validation"

          # Add validated label
          gh pr edit "$PR_NUMBER" --add-label "validated"

          echo "‚úÖ PR marked as ready for review"

      - name: Fail workflow if validation failed
        if: steps.validate.outputs.exit_code != '0'
        run: exit 1
