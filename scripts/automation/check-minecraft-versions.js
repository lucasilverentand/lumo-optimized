#!/usr/bin/env node

import fs from 'fs/promises';
import path from 'path';
import { FabricMetaAPI } from './utils/fabric-meta-api.js';
import { PackwizParser } from './utils/packwiz-parser.js';

/**
 * Check for new Minecraft versions and compare against tracked versions
 */
async function main() {
  console.log('ðŸŽ® Checking for new Minecraft versions...\n');

  try {
    // Load configuration
    const configPath = path.join(process.cwd(), 'config/automation/update-config.json');
    const configData = await fs.readFile(configPath, 'utf-8');
    const config = JSON.parse(configData);

    const fabricAPI = new FabricMetaAPI({ cacheTtlHours: config.rateLimit.cacheTtlHours });
    const parser = new PackwizParser();

    await fabricAPI.loadCache();

    // Get current pack version
    const packMeta = await parser.getPackMetadata();
    console.log(`Current pack version: MC ${packMeta.mcVersion}\n`);

    // Get recent stable Minecraft versions (latest 5)
    const trackedCount = config.minecraftVersions.track.length + 1; // +1 for main branch
    const recentVersions = await fabricAPI.getRecentMinecraftVersions(trackedCount + 2);

    console.log('Recent stable Minecraft versions:');
    recentVersions.forEach((v, i) => {
      console.log(`  ${i + 1}. ${v.version} ${v.version === packMeta.mcVersion ? '(current)' : ''}`);
    });
    console.log('');

    // Determine if there's a new version
    const latestVersion = recentVersions[0];
    const hasNewVersion = latestVersion.version !== packMeta.mcVersion;

    if (hasNewVersion) {
      console.log(`âœ¨ New Minecraft version available: ${latestVersion.version}\n`);

      // Generate issue content
      const issueContent = {
        title: `New Minecraft version: ${latestVersion.version}`,
        body: `## New Minecraft Version Detected\n\n` +
              `A new stable Minecraft version has been released.\n\n` +
              `### Version Information\n` +
              `- **New Version**: ${latestVersion.version}\n` +
              `- **Current Version**: ${packMeta.mcVersion}\n` +
              `- **Release Type**: ${latestVersion.stable ? 'Stable' : 'Snapshot'}\n\n` +
              `### Action Required\n\n` +
              `${config.minecraftVersions.autoCreateBranch ?
                `Branch creation will be handled automatically.\n\n` :
                `Please create a new branch for this Minecraft version:\n\n` +
                `\`\`\`bash\n` +
                `git checkout -b mc-${extractMajorMinor(latestVersion.version)}\n` +
                `\`\`\`\n\n`
              }` +
              `### Steps to Support New Version\n\n` +
              `1. Create new branch (if not auto-created)\n` +
              `2. Update pack.toml with new MC version\n` +
              `3. Run mod compatibility check\n` +
              `4. Remove incompatible mods\n` +
              `5. Test modpack in-game\n` +
              `6. Create PR for review\n\n` +
              `---\n` +
              `*This issue was automatically generated by the version checker*`
      };

      // Save issue content
      const issuePath = path.join(process.cwd(), 'new-version-issue.json');
      await fs.writeFile(issuePath, JSON.stringify(issueContent, null, 2));

      console.log('ðŸ“ Issue content generated and saved to new-version-issue.json');

      // Suggest branch strategy
      console.log('\nðŸ“‹ Suggested branch strategy:');
      console.log(`  â€¢ Main branch: MC ${latestVersion.version} (latest)`);

      const suggestedBranches = recentVersions
        .slice(1, trackedCount + 1)
        .map(v => `  â€¢ mc-${extractMajorMinor(v.version)}: MC ${v.version}`);

      suggestedBranches.forEach(b => console.log(b));

    } else {
      console.log('âœ“ No new Minecraft version detected');
      console.log(`  Currently on latest stable version: ${packMeta.mcVersion}\n`);
    }

    await fabricAPI.saveCache();

    // Output result for GitHub Actions
    const outputPath = path.join(process.cwd(), 'version-check-result.json');
    await fs.writeFile(outputPath, JSON.stringify({
      hasNewVersion,
      currentVersion: packMeta.mcVersion,
      latestVersion: latestVersion.version,
      recentVersions: recentVersions.map(v => v.version)
    }, null, 2));

    process.exit(hasNewVersion ? 0 : 0); // Always exit 0 - GitHub Actions checks the output file

  } catch (error) {
    console.error('âŒ Error checking Minecraft versions:', error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

/**
 * Extract major.minor version from full version string
 * @param {string} version - Full version (e.g., "1.21.8")
 * @returns {string} Major.minor version (e.g., "1.21.x")
 */
function extractMajorMinor(version) {
  const parts = version.split('.');
  if (parts.length >= 2) {
    return `${parts[0]}.${parts[1]}.x`;
  }
  return version;
}

// Run if executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}

export default main;
